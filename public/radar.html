<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAMPER</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --bg: #050505; --card: #0f0f0f; --accent: #ff0040; --border: #1a1a1a; --service: #00d4ff; --online: #00ffcc; --offline: #666; }
        body { background-color: var(--bg); color: white; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        
        .navbar { background: rgba(5,5,5,0.98); border-bottom: 1px solid var(--border); height: 70px; z-index: 1000; }
        .view-section { display: none; height: calc(100vh - 70px); overflow-y: auto; }
        .active-view { display: block; }
        


        /* Dropdown Estilo Vamped */
        .dropdown-menu-vamped { 
            background: #0f0f0f !important; 
            border: 1px solid var(--border) !important; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .dropdown-item-vamped { color: white !important; font-size: 0.9rem; padding: 10px 20px; }
        .dropdown-item-vamped:hover { background: #1a1a1a !important; color: var(--accent) !important; }

        /* Grid de Usuarios */
        .user-card { position: relative; aspect-ratio: 1/1; background: var(--card); border: 1px solid var(--border); cursor: pointer; overflow: hidden; }
        .user-card img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .user-card:hover img { transform: scale(1.05); }

        .user-info-tag {
            position: absolute; bottom: 0; padding: 8px; width: 100%;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
        }
        .user-name { font-size: 0.85rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        
        .online-dot { 
            width: 8px; height: 8px; background: var(--online); border-radius: 50%; 
            box-shadow: 0 0 8px var(--online), 0 0 12px var(--online);
            display: inline-block;
        }


.offline-dot { 
    width: 8px; height: 8px; 
    background: #444 !important; /* Gris oscuro */
    border-radius: 50%; 
    display: inline-block;
    box-shadow: none !important; /* Sin brillo ne칩n */
}

        .time-text { font-size: 0.65rem; color: var(--offline); display: block; margin-bottom: 2px; }
        .user-status-text { 
            color: var(--service); font-size: 0.65rem; font-weight: normal; 
            text-transform: uppercase; letter-spacing: 0.5px; display: block;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            opacity: 0.9;
        }

        /* Chat UI */
        .chat-sidebar { background: #080808; border-right: 1px solid var(--border); overflow-y: auto; }
        .chat-item { cursor: pointer; border-left: 3px solid transparent; transition: 0.2s; border-bottom: 1px solid #111; }
        .chat-item:hover { background: #1a1a1a; }
        .chat-item.active { background: #151515; border-left-color: var(--accent); }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; background: #050505; height: 100%; }
        .msg-bubble { padding: 8px 15px; border-radius: 18px; max-width: 80%; margin-bottom: 10px; word-wrap: break-word; font-size: 0.95rem; }
        .msg-sent { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 2px; }
        .msg-received { align-self: flex-start; background: #262626; color: #e0e0e0; border-bottom-left-radius: 2px; }
        
        /* Modales Estilo Vamped */
        .vamped-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content-vamped { background: #0f0f0f; border: 1px solid var(--accent); width: 90%; max-width: 350px; padding: 20px; border-radius: 15px; box-shadow: 0 0 30px rgba(255, 0, 64, 0.2); }
        .slider-container { position: relative; width: 100%; aspect-ratio: 1/1; margin-bottom: 15px; border-radius: 5px; overflow: hidden; }
        #modalImg { width: 100%; height: 100%; object-fit: cover; }

        .vamped-input-dark {
            background: #1a1a1a; border: 1px solid var(--border); color: white;
            padding: 12px; width: 100%; border-radius: 8px; margin-bottom: 15px; outline: none;
        }
        .vamped-input-dark:focus { border-color: var(--service); }

        #myCurrentStatusDisplay {
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
    </style>
</head>
<body>
<div id="analogGlitchEffect" class="analog-glitch-layer"></div>

<div id="v-intro-gate" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:30000; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
    
    <pre id="v-skull-ascii" style="color:#ff0040; font-size:9px; line-height:1; margin-bottom:20px; text-shadow: 0 0 10px #ff0040; cursor:default; user-select:none;">
         uuuuuuu
             uu$$$$$$$$$$$uu
          uu$$$$$$$$$$$$$$$$$uu
         u$$$$$$$$$$$$$$$$$$$$$u
        u$$$$$$$$$$$$$$$$$$$$$$$u
       u$$$$$$$$$$$$$$$$$$$$$$$$$u
       u$$$$$$$$$$$$$$$$$$$$$$$$$u
       u$$$$$$"   "$$$"   "$$$$$$u
       "$$$$"      u$u       $$$$"
        $$$u       u$u       u$$$
        $$$u      u$$$u      u$$$
         "$$$$uu$$$   $$$uu$$$$"
          "$$$$$$$"   "$$$$$$$"
            u$$$$$$$u$$$$$$$u
             u$"$"$"$"$"$"$u
  uuu        $$u$ $ $ $ $u$$       uuu
 u$$$$        $$$$$u$u$u$$$       u$$$$
  $$$$$uu      "$$$$$$$$$"     uu$$$$$$
u$$$$$$$$$$$uu    """""    uuuu$$$$$$$$$$
$$$$"""$$$$$$$$$$uuu   uu$$$$$$$$$"""$$$"
 """      ""$$$$$$$$$$$uu ""$"""
           uuuu ""$$$$$$$$$$uuu
  u$$$uuu$$$$$$$$$uu ""$$$$$$$$$$$uuu$$$
  $$$$$$$$$$""""           ""$$$$$$$$$$$"
   "$$$$$"                      ""$$$$""
     $$$"                         $$$$"
    </pre>

    <button id="v-start-btn" style="background:transparent; border:1px solid #ff0040; color:#ff0040; padding:15px 35px; font-family:monospace; cursor:pointer; letter-spacing:2px; text-transform:uppercase; transition: all 0.3s ease; position:relative; overflow:hidden;">
        DOWNLOAD VAMPER_SYSTEM_MALWARE
    </button>

    <style>
        #v-skull-ascii {
            animation: v-flicker 0.15s infinite alternate;
        }

        #v-start-btn:hover {
            background: #ff0040;
            color: #000;
            box-shadow: 0 0 30px #ff0040;
        }

        @keyframes v-flicker {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.01); filter: contrast(1.2); }
        }
    </style>
</div>

<div id="vamper-loader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:20000;">
    <div class="loader-content">
        <h2 class="loader-title">VAMPER_SYSTEM_INITIALIZING...</h2>
        <div class="progress-container">
            <div class="scan-line"></div> 
        </div>
        <div id="system-disclaimer" class="system-red-text">
            </div>
        <div class="loader-footer">
            <span>STATUS: SCANNING_FREQUENCIES</span>
            <span id="load-perc">0%</span>
        </div>
    </div>
</div>
<style>
.analog-glitch-layer {
  position: fixed; /* Para cubrir toda la pantalla */
  top: 0;
  left: 0;
  width: 100vw; /* Viewport width */
  height: 100vh; /* Viewport height */
  pointer-events: none; /* Para que no bloquee clics */
  z-index: 9999; /* Aseg칰rate de que est칠 encima de todo */
  opacity: 0; /* Por defecto, est치 invisible */
  background: radial-gradient(circle, rgba(255,0,0,0.1) 0%, rgba(0,255,255,0.1) 100%); /* Efecto RGB tenue */
  mix-blend-mode: overlay; /* Para que interact칰e con el fondo */
  transition: opacity 0.1s ease-out; /* Transici칩n suave para aparecer/desaparecer */
}

/* Animaci칩n principal del barrido */
@keyframes analogBarrido {
  0% {
    transform: translateY(0) scaleY(1);
    filter: hue-rotate(0deg) saturate(100%);
    opacity: 0.1;
  }
  20% {
    transform: translateY(10%) scaleY(0.8) skewX(5deg);
    filter: hue-rotate(90deg) saturate(200%);
    opacity: 0.8;
  }
  40% {
    transform: translateY(-5%) scaleY(1.2) skewX(-3deg);
    filter: hue-rotate(180deg) saturate(150%);
    opacity: 0.6;
  }
  60% {
    transform: translateY(15%) scaleY(0.7) skewX(8deg);
    filter: hue-rotate(270deg) saturate(250%);
    opacity: 0.9;
  }
  80% {
    transform: translateY(-10%) scaleY(1.1) skewX(-6deg);
    filter: hue-rotate(360deg) saturate(180%);
    opacity: 0.7;
  }
  100% {
    transform: translateY(0) scaleY(1);
    filter: hue-rotate(0deg) saturate(100%);
    opacity: 0.1;
  }
}

/* Clases para activar y desactivar */
.analog-glitch-layer.active {
  animation: analogBarrido 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite alternate; /* O infinite */
  opacity: 1; /* Para que se vea */
}

/* Puedes a침adir m치s efectos, como un desplazamiento general de la pantalla */
.glitch-full-screen {
  animation: screenShake 0.1s infinite alternate;
}

@keyframes screenShake {
  0% { transform: translate(0, 0); }
  50% { transform: translate(1px, 1px); }
  100% { transform: translate(-1px, -1px); }
}

.system-red-text {
    color: #ff003c;
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.8rem;
    text-align: left;
    margin-top: 20px;
    letter-spacing: 1px;
    text-shadow: 0 0 8px #ff003c; /* Efecto ne칩n */
    opacity: 0.8;
}

.system-red-text p {
    margin: 5px 0;
    overflow: hidden;
    white-space: nowrap;
    border-right: 2px solid #ff003c; /* Cursor parpadeante */
    animation: typing 3s steps(40, end), blink .75s step-end infinite;
}

/* Animaci칩n de escritura mec치nica */
@keyframes typing { from { width: 0 } to { width: 100% } }
@keyframes blink { from, to { border-color: transparent } 50% { border-color: #ff003c } }
</style>





<script>
    

// Funci칩n principal que activa el barrido anal칩gico
function triggerAnalogGlitch(durationMs = 500) {
  const glitchLayer = document.getElementById('analogGlitchEffect');
  if (!glitchLayer) return;

  // Activamos la capa y el temblor de pantalla
  glitchLayer.classList.add('active');
  document.body.classList.add('glitch-full-screen');

  // Lo desactivamos tras la duraci칩n especificada
  setTimeout(() => {
    glitchLayer.classList.remove('active');
    document.body.classList.remove('glitch-full-screen');
  }, durationMs);
}

// Bucle de ejecuci칩n aleatoria (El "Fantasma en la M치quina")
function startAutoGlitch() {
  // Generamos un tiempo aleatorio entre 10 y 30 segundos para el pr칩ximo glitch
  const proximoGlitch = Math.random() * (120000 - 10000) + 10000;

  setTimeout(() => {
    // Duraci칩n aleatoria del glitch (entre 200ms y 600ms)
    const duracion = Math.random() * (600 - 200) + 200;
    
    triggerAnalogGlitch(duracion);
    
    // Volvemos a llamar a la funci칩n para que sea infinito
    startAutoGlitch();
  }, proximoGlitch);
}

// Iniciar el sistema cuando la p치gina cargue
window.onload = () => {
  startAutoGlitch();
  console.log("Sistema de interferencia Mortifer activo...");
};

// --- EJEMPLOS DE USO ---

// 1. Glitch sutil al hablar con Nadie
// En el c칩digo de tu chat, cuando Nadie responde:
// triggerAnalogGlitch(300); // Glitch de 300ms

// 2. Glitch m치s intenso al mencionar a Mortifer (con temblor de pantalla)
// En el c칩digo de tu chat, cuando se detecta la palabra 'Mortifer':
// triggerAnalogGlitch(800, true); // Glitch de 800ms con temblor de pantalla

// 3. Glitch aleatorio en el fondo (como el evento de la "Conspiraci칩n del Agua")
// setInterval(() => {
//   if (Math.random() < 0.1) { // 10% de probabilidad cada 5 segundos
//     triggerAnalogGlitch(Math.random() * 500 + 200, Math.random() < 0.3); // Duraci칩n y shake aleatorios
//   }
// }, 5000); // Cada 5 segundos

</script>


























<style>
#vamper-loader {
    /* Estas 5 l칤neas evitan que se superponga con el fondo */
    position: fixed;        /* Se queda quieto sobre toda la pantalla */
    top: 0;
    left: 0;
    width: 100vw;           /* 100% del ancho del visor */
    height: 100vh;          /* 100% del alto del visor */
    z-index: 99999;         /* Por encima de absolutamente todo */
    
    /* Fondo negro s칩lido para que no se trasluzca nada */
    background: #000;
    
    /* Centrado de la barra y el texto */
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    
    color: #ff003c;
    font-family: 'Courier New', Courier, monospace;
}

/* Esta clase es la que activa tu JS al llegar al 100% */
.loader-hidden {
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.8s ease, visibility 0.8s;
}

.progress-container {
    width: 300px;
    height: 4px;
    background: #1a1a1a;
    border: 1px solid #333;
    margin: 20px 0;
    overflow: hidden;
}

.scan-line {
    height: 100%;
    width: 0%; /* Empieza en 0 */
    background: #ff003c;
    box-shadow: 0 0 15px #ff003c;
    transition: width 0.2s ease-out;
}
</style>


<style>
/* Bloqueamos la visi칩n de todo el sistema operativo de VAMPER */
#v-everything-wrapper {
    display: none; /* Desaparecido totalmente */
    opacity: 0;
    transition: opacity 1.5s ease-in;
}
</style>

<style>




</style>
<nav class="navbar px-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
        <strong style="letter-spacing:4px; cursor:pointer; color: var(--accent); font-size: 1.2rem;" onclick="showView('radar-view')">VAMPER</strong>
        <i class="bi bi-chat-dots fs-4" style="cursor:pointer" onclick="showView('chat-view')"></i>
        
        <div class="d-flex align-items-center gap-2" style="cursor:pointer" onclick="openStatusModal()">
            <i class="bi bi-clock-history fs-4" style="color: var(--service);"></i>
            <span id="myCurrentStatusDisplay" style="color: var(--service);"></span>
        </div>

        <div class="d-flex align-items-center ms-1" style="cursor:pointer" onclick="openGalleryModal()">
            <i class="bi bi-camera-fill fs-4" style="color: var(--accent); filter: drop-shadow(0 0 5px var(--accent));"></i>
        </div>

        <div class="d-flex align-items-center ms-1" style="cursor:pointer" onclick="toggleVamperRadio()" title="Sincronizar Audio">
            <i id="audio-icon" class="bi bi-broadcast fs-4" style="color: var(--accent); transition: all 0.3s ease;"></i>
        </div>
        <div id="vamper-clock" class="digital-clock">00:00:00</div>
    </div>

    <div class="beeper-container d-none d-md-flex flex-grow-1 mx-4">
        <div id="beeper-ticker" class="beeper-text">
            </div>
    </div>
  
    <div class="d-flex align-items-center gap-3">
        <button class="btn btn-danger rounded-circle" onclick="saveNewStatus()" title="Actualizar Estado" style="width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-arrow-clockwise" style="font-size: 1.2rem;"></i>
        </button>
        <div class="dropdown">
            <img id="myProfilePic" src="" class="dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" 
                 style="width:38px; height:38px; border-radius:50%; border:2px solid var(--accent); cursor:pointer; display:none; object-fit: cover;">
            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-vamped">
                <li><a class="dropdown-item dropdown-item-vamped" href="#" onclick="openEditModal()">
                    <i class="bi bi-person-gear me-2"></i>Editar Perfil</a>
                </li>
                <li><hr class="dropdown-divider border-secondary"></li>
                <li><a class="dropdown-item dropdown-item-vamped text-danger" href="#" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesi칩n</a>
                </li>
            </ul>
        </div>
    </div>
</nav>











</script>







<div id="statusUpdateModal" class="vamped-modal-overlay" onclick="closeStatusModal()">
    <div class="modal-content-vamped text-center" onclick="event.stopPropagation()">
        <i class="bi bi-clock-history fs-2 mb-2" style="color: var(--service);"></i>
        <h5 class="mb-3">MI ESTADO ACTUAL</h5>
        <input type="text" id="statusInput" class="vamped-input-dark" placeholder="쯈u칠 est치s haciendo?..." maxlength="45">
        <div class="d-grid gap-2">
            <button class="btn btn-danger fw-bold" onclick="saveNewStatus()">ACTUALIZAR</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="closeStatusModal()">CANCELAR</button>
        </div>
    </div>
</div>


<script>
    
    function updateClock() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    
    document.getElementById('vamper-clock').textContent = `${hours}:${minutes}:${seconds}`;
}

// Ejecutar cada segundo
setInterval(updateClock, 1000);
// Llamar de inmediato para evitar el lag de 1s al cargar
updateClock();
</script>

<style>

    .nav-right-section {
    display: flex;
    align-items: center; /* Alinea todo verticalmente al centro */
    gap: 15px;           /* Da espacio uniforme entre beeper, reloj y foto */
}

.digital-clock {
    font-family: 'Courier New', monospace;
    color: #00FF41;
    text-shadow: 0 0 8px #00FF41;
    font-size: 14px; /* Ajusta seg칰n el tama침o de tu nav */
    font-weight: bold;
    min-width: 80px; /* Evita que el layout salte cuando cambian los n칰meros */
    text-align: center;
}

.beeper-container {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(0, 255, 255, 0.2);
    border-radius: 4px;
    height: 32px;
    overflow: hidden;
    position: relative;
    display: flex;
    align-items: center;
}

.beeper-text {
    white-space: nowrap;
    position: absolute;
    font-family: 'monospace';
    font-size: 0.85rem;
    color: var(--accent);
    text-shadow: 0 0 5px var(--accent);
    text-transform: uppercase;
    left: 100%; /* Empieza fuera a la derecha */
    will-change: left;
}
</style>

    
<script>
const avisosVamper = [
    "SISTEMA VAMPER V.3.1 :: LOCALIZATOR ACTIVO",
    "BOTILLER칈A: PROMO PACK PISCO + BEBIDA ACTIVA HASTA LAS 05:00 AM 游꽁",
    "EL MAESTRO SANGUCHERO REPORTA: CARB칍N EN SU PUNTO M츼XIMO 游댠",
    "UNIDADES DE TRANSPORTE EN L칈NEA: 5 DISPONIBLES EN VI칌A 游뚱",
    "COMUNIDAD: 124 USUARIOS RASTREADOS EN EL RADAR AHORA MISMO 游니",
    "OFERTA REL츼MPAGO: SEGUNDO S츼NDWICH CON 30% DSCTO EN EL BAJ칍N 游꼢",
    "BOTILLER칈A: STOCK RELLENADO - CERVEZAS HELADAS LISTAS",
    "VAMPER GIRL: REVISA NUESTRO CAT츼LOGO DE TRAGOS VIP 游볙",
    "LOG칈STICA: TIEMPO ESTIMADO DE LLEGADA: 8 MINUTOS",
    "ALERTA: NUEVOS EVENTOS PR칍XIMAMENTE EN TU ZONA... MANT칄N EL RADAR ABIERTO"
];

let beeperAnimationFrame; // Para tener control del ciclo

function startBeeper() {
    const ticker = document.getElementById('beeper-ticker');
    const container = ticker ? ticker.parentElement : null;
    
    if (!ticker || !container) return;

    function animateNext() {
        // 1. Cancelar cualquier animaci칩n previa para evitar duplicados
        cancelAnimationFrame(beeperAnimationFrame);

        // 2. Elegir mensaje aleatorio
        const randomMsg = avisosVamper[Math.floor(Math.random() * avisosVamper.length)];
        ticker.innerText = `>>> ${randomMsg} <<<`;
        
        // 3. Peque침a pausa para que el DOM registre el nuevo texto y su ancho
        setTimeout(() => {
            const containerWidth = container.offsetWidth;
            const textWidth = ticker.offsetWidth;
            let currentPos = containerWidth;
            
            ticker.style.left = currentPos + "px";

            function step() {
                currentPos -= 2.2; // Velocidad suave
                ticker.style.left = currentPos + "px";

                if (currentPos < -textWidth) {
                    animateNext(); // Reiniciar con mensaje nuevo
                } else {
                    beeperAnimationFrame = requestAnimationFrame(step);
                }
            }
            beeperAnimationFrame = requestAnimationFrame(step);
        }, 50); 
    }

    animateNext();
}

// Iniciar al cargar el DOM
document.addEventListener('DOMContentLoaded', startBeeper);
</script>




<div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; overflow-y:auto; padding:20px;">
    
    <div style="max-width: 500px; margin: 40px auto; background: #0f0f0f; border: 1px solid var(--accent); padding: 30px; border-radius: 15px; position: relative; box-shadow: 0 0 20px rgba(255, 0, 64, 0.2);">
        
        <span onclick="cerrarModal()" style="position:absolute; top:15px; right:20px; color:var(--accent); cursor:pointer; font-weight:bold; font-size:1.8rem;">&times;</span>
        
        <h2 style="color: white; letter-spacing: 2px; margin-bottom: 5px;">MI PERFIL</h2>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 30px;">Actualiza tu identidad</p>

        <form id="editForm">
            <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 25px;">
                <div style="width: 130px; height: 130px; border-radius: 50%; border: 2px solid var(--accent); position: relative; overflow: hidden; background: #000; box-shadow: 0 0 15px rgba(255, 0, 64, 0.3);">
                    <img id="edit-p-prev" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                </div>
                <label for="edit-photo-upload" style="margin-top: 15px; background: #1a1a1a; color: white; padding: 8px 20px; border-radius: 20px; cursor: pointer; border: 1px solid #333; font-size: 0.8rem;">
                    <i class="bi bi-camera me-2"></i>Cambiar Foto
                </label>
                <input id="edit-photo-upload" type="file" accept="image/*" style="display: none;">
            </div>

            <div class="mb-3">
                <label class="form-label small text-muted text-uppercase">Nickname</label>
                <input type="text" id="edit-nickname" class="vamped-input-dark" placeholder="Tu nombre en las sombras" style="margin-bottom: 10px;">
            </div>

            <div id="edit-personal-fields" class="hidden mb-3">
                <label class="form-label small text-muted text-uppercase">Estado actual</label>
                <input type="text" id="edit-status" class="vamped-input-dark" placeholder="쯈u칠 est치s haciendo?">
            </div>

            <div id="edit-service-fields" class="hidden mb-3">
                <label class="form-label small text-muted text-uppercase">Descripci칩n del Servicio</label>
                <textarea id="edit-description" class="vamped-input-dark" style="height: 100px; resize: none;"></textarea>
            </div>

            <button type="submit" class="btn btn-danger w-100 fw-bold py-3" style="border-radius: 10px; letter-spacing: 1px;">
                GUARDAR CAMBIOS
            </button>
            
            <div id="edit-msg" style="text-align: center; margin-top: 15px; font-size: 0.75rem; font-weight: bold;"></div>
        </form>
    </div>
</div>


<Style>
.vamped-input-dark {
    background: #1a1a1a !important;
    border: 1px solid #333 !important;
    color: white !important;
    padding: 12px;
    width: 100%;
    border-radius: 8px;
    outline: none;
    transition: 0.3s;
}

.vamped-input-dark:focus {
    border-color: var(--accent) !important;
    box-shadow: 0 0 10px rgba(255, 0, 64, 0.1);
}

.hidden { display: none; }

</Style>


<div id="galleryModal" class="vamped-modal-overlay" onclick="closeGalleryModal()">
    <div class="modal-content-vamped" onclick="event.stopPropagation()" style="max-width: 400px; border-color: var(--accent);">
        
        <div style="background: rgba(255, 0, 64, 0.05); border: 1px solid rgba(255, 0, 64, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
            <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-shield-slash-fill" style="color: var(--accent); font-size: 1.2rem;"></i>
                <strong style="font-size: 0.75rem; letter-spacing: 1px; color: var(--accent);">AVISO DE SEGURIDAD</strong>
            </div>
            <p style="font-size: 0.7rem; line-height: 1.3; color: #bbb; margin: 0; text-align: justify;">
                Ten mucho cuidado a qui칠n le das acceso a tu galer칤a de fotos, sobre todo si muestras tu rostro. 
                <strong>Verifica la identidad</strong> de la otra persona antes de compartir contenido o datos personales. 
                En VAMPER, el pseudo-anonimato es tu principal herramienta para conocer gente de forma segura y discreta.
            </p>
        </div>

        <h5 class="text-center mb-3" style="letter-spacing: 2px; font-size: 0.9rem; color: white;">Galeria</h5>
        
        <div class="d-flex justify-content-between gap-2 mb-4">
            <div class="gallery-slot" onclick="document.getElementById('file-1').click()">
                <input type="file" id="file-1" accept="image/*" hidden onchange="previewGallery(this, 'prev-1')">
                <img id="prev-1" src="" style="display:none; width:100%; height:100%; object-fit:cover;">
                <i class="bi bi-camera" id="icon-1"></i>
            </div>
            <div class="gallery-slot" onclick="document.getElementById('file-2').click()">
                <input type="file" id="file-2" accept="image/*" hidden onchange="previewGallery(this, 'prev-2')">
                <img id="prev-2" src="" style="display:none; width:100%; height:100%; object-fit:cover;">
                <i class="bi bi-camera" id="icon-2"></i>
            </div>
            <div class="gallery-slot" onclick="document.getElementById('file-3').click()">
                <input type="file" id="file-3" accept="image/*" hidden onchange="previewGallery(this, 'prev-3')">
                <img id="prev-3" src="" style="display:none; width:100%; height:100%; object-fit:cover;">
                <i class="bi bi-camera" id="icon-3"></i>
            </div>
        </div>

        <div class="d-grid gap-2">
            <button class="btn btn-danger fw-bold py-2" onclick="saveGallery()">GUARDAR GALER칈A</button>
            <button class="btn btn-link btn-sm text-muted text-decoration-none" onclick="closeGalleryModal()">CERRAR</button>
        </div>
    </div>
</div>

<style>
    .gallery-slot {
        width: 100px;
        height: 100px;
        background: #1a1a1a;
        border: 1px dashed var(--accent);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: 0.3s;
    }
    .gallery-slot:hover {
        background: #222;
        border-style: solid;
        box-shadow: 0 0 10px rgba(255, 0, 64, 0.2);
    }
    .gallery-slot i {
        font-size: 1.5rem;
        color: var(--accent);
    }



</style>










<script>


    function openGalleryModal() {
    document.getElementById('galleryModal').style.display = 'flex';
}

function closeGalleryModal() {
    document.getElementById('galleryModal').style.display = 'none';
}

// Funci칩n para previsualizar la foto antes de subirla
function previewGallery(input, imgId) {
    const file = input.files[0];
    const iconId = 'icon-' + imgId.split('-')[1];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById(imgId);
            const icon = document.getElementById(iconId);
            img.src = e.target.result;
            img.style.display = 'block';
            icon.style.display = 'none'; // Esconde el icono de c치mara
        }
        reader.readAsDataURL(file);
    }
}

// Funci칩n para enviar las 3 fotos al servidor (puedes adaptarla a tu API)
async function saveGallery() {
    const btn = event.target;
    btn.innerText = "SUBIENDO...";
    
    // Aqu칤 recolectar칤as los Base64 de las im치genes prev-1, prev-2, prev-3
    // y los enviar칤as a tu ruta de /api/user/update o una nueva /api/user/gallery
    
    setTimeout(() => {
        alert("춰Galer칤a actualizada con 칠xito!");
        btn.innerText = "GUARDAR GALER칈A";
        closeGalleryModal();
    }, 1500);
}



let nuevaImagenBase64 = "";



async function openEditModal() {
    const modal = document.getElementById('editModal');
    // CORRECCI칍N: Usa 'vamped_token' para que coincida con el resto de tu app
    const token = localStorage.getItem('vamped_token'); 
    const msg = document.getElementById('edit-msg');
    if(msg) msg.innerText = "";
    
    modal.style.display = 'block';

    try {
        const res = await fetch('/api/user/me', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        // Verificamos si la respuesta es exitosa antes de procesar
        if (!res.ok) throw new Error("Error en la autenticaci칩n");

        const user = await res.json();

        // Rellenar campos
        document.getElementById('edit-nickname').value = user.nickname || "";
        
        // Cargar imagen
        const imgPrev = document.getElementById('edit-p-prev');
        if (user.photo) {
            imgPrev.src = user.photo; // Asigna la URL o Base64 del back
            imgPrev.style.display = 'block'; // Asegura que sea visible
        }

        // L칩gica de campos seg칰n tipo de cuenta
        const serviceFields = document.getElementById('edit-service-fields');
        const personalFields = document.getElementById('edit-personal-fields');

        if (user.accountType === 'servicio') {
            serviceFields.classList.remove('hidden');
            personalFields.classList.add('hidden');
            document.getElementById('edit-description').value = user.description || "";
        } else {
            personalFields.classList.remove('hidden');
            serviceFields.classList.add('hidden');
            document.getElementById('edit-status').value = user.status || "";
        }

    } catch (err) {
        console.error("Error al obtener datos del usuario:", err);
        if(msg) msg.innerText = "SESI칍N EXPIRADA O ERROR DE RED";
    }
}
function cerrarModal() {
    document.getElementById('editModal').style.display = 'none';
    nuevaImagenBase64 = ""; // Resetear preview temporal
}

// Previsualizaci칩n de nueva imagen
document.getElementById('edit-photo-upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            nuevaImagenBase64 = event.target.result;
            const img = document.getElementById('edit-p-prev');
            img.src = nuevaImagenBase64;
            img.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

// Enviar formulario corregido
document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // CORRECCI칍N: Usar 'vamped_token' que es el que definiste globalmente
    const token = localStorage.getItem('vamped_token'); 
    const msg = document.getElementById('edit-msg');
    
    msg.style.color = "white";
    msg.innerText = "PROCESANDO CAMBIOS...";

    // Capturamos los valores, manejando si los campos est치n ocultos (null)
    const nickname = document.getElementById('edit-nickname').value;
    const statusField = document.getElementById('edit-status');
    const descField = document.getElementById('edit-description');

    const datosUpdate = {
        nickname: nickname,
        status: statusField ? statusField.value : "",
        description: descField ? descField.value : ""
    };

    if (nuevaImagenBase64) {
        datosUpdate.photo = nuevaImagenBase64;
    }

    try {
        const res = await fetch('/api/user/update', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` // Se env칤a al middleware 'protect'
            },
            body: JSON.stringify(datosUpdate)
        });

        if (res.ok) {
            const data = await res.json();
            
            // Opcional: Actualizar el objeto local para que los cambios sean inmediatos
            let myUser = JSON.parse(localStorage.getItem('vamped_user')) || {};
            myUser.nickname = data.nickname;
            myUser.photo = data.photo;
            localStorage.setItem('vamped_user', JSON.stringify(myUser));

            msg.style.color = "#00ff88";
            msg.innerText = "PERFIL ACTUALIZADO";
            
            setTimeout(() => {
                cerrarModal();
                window.location.reload(); 
            }, 1500);
        } else {
            const errorRes = await res.json();
            msg.style.color = "var(--accent)";
            msg.innerText = errorRes.msg || "ERROR AL ACTUALIZAR";
        }
    } catch (err) {
        msg.innerText = "ERROR DE CONEXI칍N";
        console.error("Error en update:", err);
    }
});
</script>



<div id="radar-view" class="view-section active-view container-fluid p-2">
    <div class="row g-1 row-cols-2 row-cols-md-4 row-cols-lg-6" id="main-grid"></div>

    <div class="vamper-footer-ads mt-4">
        <div class="row g-2"> 
            <div class="col-12 col-md-6">
                <div class="footer-poster" id="ad-slot-1">
                    <img src="/anuncios/1.jpg" class="ad-image active" alt="Vamper Ad">
                    <img src="/anuncios/3.jpg" class="ad-image" alt="Vamper Ad">
                    <img src="/anuncios/5.jpg" class="ad-image" alt="Vamper Ad">
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="footer-poster" id="ad-slot-2">
                    <img src="/anuncios/2.jpg" class="ad-image active" alt="Vamper Ad">
                    <img src="/anuncios/4.jpg" class="ad-image" alt="Vamper Ad">
                    <img src="/anuncios/6.jpg" class="ad-image" alt="Vamper Ad">
                </div>
            </div>
        </div>
    </div>

    <div id="radar-view-2" class="mt-5 pt-4 border-top border-dark">
        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
            <h6 class="text-uppercase fw-bold m-0" style="letter-spacing: 3px; color: #444;">
                <i class="bi bi-broadcast me-2"></i> Escaneo de Frecuencia Secundario
            </h6>
            <span class="badge rounded-pill" style="background: #111; color: #ff0000; border: 1px solid #300;">EN L칈NEA</span>
        </div>
        
        <div class="row g-1 row-cols-3 row-cols-md-6 row-cols-lg-8" id="secondary-grid">
            <div class="col">
                <div class="user-mini-card"></div>
            </div>
        </div>
    </div>
</div>

<div id="chat-view" class="view-section container-fluid p-0">
    <div class="d-flex h-100">
        <div class="chat-sidebar col-4 col-md-3 d-flex flex-column" id="conversations-list" style="background: #080808;">
            <div class="p-3 small text-muted text-uppercase" style="letter-spacing: 2px; font-size: 0.7rem;">Log de Actividad</div>
        </div>

        <div class="col-8 col-md-9 d-flex flex-column h-100" style="background: #050505;">
            <div id="chat-header" class="p-3 border-bottom border-secondary small fw-bold text-uppercase" style="letter-spacing:2px; color: var(--accent); background: #050505;">
                MONITOREANDO: <span id="chat-user-name">...</span>
            </div>
            
            <div id="chat-messages" class="chat-messages flex-grow-1 p-3">
                </div>

            <div class="p-3" style="background: #080808; border-top: 1px solid #1a1a1a;">
                <div style="position: relative; display: flex; align-items: center;">
                    <input type="text" id="chat-input" 
                        style="width: 100%; background: #151515; border: 1px solid #333; color: white; padding: 12px 60px 12px 15px; border-radius: 30px; outline: none; transition: 0.3s;" 
                        placeholder="Escribe un mensaje..." 
                        onkeypress="if(event.key==='Enter') sendMessage()">
                    
                    <button onclick="sendMessage()" 
                        style="position: absolute; right: 5px; background: var(--accent); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s;">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    
</script>
<style>
/* --- ESTILOS DE LA SECCI칍N DE ANUNCIOS --- */

.vamper-footer-ads {
    padding: 10px;
    background: rgba(0, 0, 0, 0.8);
    /* Borde Ne칩n Principal */
    border: 2px solid #ff003c; 
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(255, 0, 60, 0.6), 
                inset 0 0 15px rgba(255, 0, 60, 0.3);
    margin-bottom: 50px; /* Espacio para no chocar con el borde inferior */
    position: relative;
    z-index: 10;
}

.footer-poster {
    position: relative;
    width: 100%;
    /* Mantiene el formato 2:1 aproximadamente de tus anuncios originales */
    aspect-ratio: 16 / 8; 
    overflow: hidden;
    border-radius: 8px;
    background: #000;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.ad-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain; /* IMPORTANTE: Mantiene el formato original sin estirar */
    opacity: 0;
    transform: scale(1.1) translateY(10px);
    transition: opacity 0.2s ease-in-out, transform 0.2s ease-out;
    z-index: 1;
}

/* Estado de la imagen visible (Efecto Flash) */
.ad-image.active {
    opacity: 1;
    transform: scale(1) translateY(0);
    z-index: 2;
}


@keyframes neon-pulse {
    0% { box-shadow: 0 0 20px rgba(255, 0, 60, 0.6); }
    50% { box-shadow: 0 0 40px rgba(255, 0, 60, 1), 0 0 60px rgba(255, 0, 60, 0.8); }
    100% { box-shadow: 0 0 20px rgba(255, 0, 60, 0.6); }
}

/* --- RESPETAR EL RESTO DE LA APP --- */
::-webkit-scrollbar { display: none; }
.view-section {
    overflow-y: scroll; 
    height: calc(100vh - 70px);
    scrollbar-width: none;
    -ms-overflow-style: none;
}
</style>

<script>


document.addEventListener('DOMContentLoaded', () => {
    const slots = [
        document.getElementById('ad-slot-1'),
        document.getElementById('ad-slot-2')
    ];

    function rotateAds(slot) {
        const images = slot.querySelectorAll('.ad-image');
        const activeImg = slot.querySelector('.ad-image.active');
        let nextIndex = Array.from(images).indexOf(activeImg) + 1;

        if (nextIndex >= images.length) nextIndex = 0;

        // Quitamos clase active a la actual
        activeImg.classList.remove('active');
        
        // Efecto Flash en el borde ne칩n del contenedor padre
        const container = slot.closest('.vamper-footer-ads');
        container.classList.remove('flash-border');
        void container.offsetWidth; // Trigger reflow para reiniciar animaci칩n
        container.classList.add('flash-border');

        // Activamos la siguiente imagen
        images[nextIndex].classList.add('active');
    }

    // Intervalo de cambio r치pido ("Flash") cada 3 segundos (3000ms)
    // Usamos tiempos ligeramente distintos para que no cambien exactamente igual
    setInterval(() => rotateAds(slots[0]), 5000);
    setTimeout(() => {
        setInterval(() => rotateAds(slots[1]), 8000);
    }, 1500); // El segundo slot empieza con desfase para m치s dinamismo
});
</script>



<div id="profileModal" class="vamped-modal-overlay" onclick="this.style.display='none'">
    <div class="modal-content-vamped text-center vamped-anim-in" onclick="event.stopPropagation()">
        <div class="slider-container"><img id="modalImg" src=""></div>
        <h5 id="modalName" class="mb-0"></h5>
        <div id="modalTime" class="time-text mb-1"></div>
        <div id="modalStatusDisplay" class="small mb-2" style="color: var(--service); font-style: italic;"></div>
        <p id="modalDesc" class="small text-muted mb-3"></p>
        <div class="d-grid gap-2">
            <button class="btn btn-danger" onclick="goToChat()">CHAT</button>
            <button id="btnAlbum" class="btn btn-warning fw-bold text-dark" onclick="alert('Abriendo 츼lbum...')">
                <i class="bi bi-images me-1"></i> VER 츼LBUM
            </button>
        </div>
    </div>
</div>

<style>

    




/* El cuerpo del Modal */
.modal-content-vamped {
    background: #0a0a0a !important; 
    border: 1px solid #1a1a1a; 
    border-radius: 2px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 1), 
                inset 0 0 10px rgba(255, 0, 0, 0.05);
    padding: 20px;
    max-width: 400px;
    position: relative;
    color: #e0e0e0;
    /* Optimizaci칩n de hardware */
    will-change: transform, opacity;
}

/* El Ne칩n Negro - Simplificado para evitar lag de capas */
.modal-content-vamped::after {
    content: "";
    position: absolute;
    top: -1px; left: -1px; right: -1px; bottom: -1px;
    background: #111;
    z-index: -1;
    border-radius: 2px;
}

/* T칤tulos y Texto */
#modalName {
    font-family: 'serif';
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #fff;
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
}

.text-muted {
    color: #777 !important;
    font-style: italic;
}

/* Botones con respuesta INSTANT츼NEA (0.1s) */
.modal-content-vamped .btn-danger {
    background: transparent !important;
    border: 1px solid #ff0000;
    color: #ff0000;
    text-transform: uppercase;
    font-weight: bold;
    transition: all 0.1s ease-out; /* Cambio ultra r치pido */
}

.modal-content-vamped .btn-danger:hover {
    background: #ff0000 !important;
    color: #000;
    box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    transform: translateY(-1px); /* Feedback t치ctil leve */
}

/* Definimos la animaci칩n: Un peque침o salto de escala y entrada de luz */
@keyframes vamperFadeIn {
    0% {
        opacity: 0;
        transform: scale(0.9) translateY(10px);
        filter: brightness(2); /* Empieza con un destello de luz */
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
        filter: brightness(1);
    }
}

/* Esta clase se activa cuando el modal aparece */
.vamped-anim-in {
    animation: vamperFadeIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.modal-content-vamped .btn-warning {
    background: #151515 !important;
    border: 1px solid #333;
    color: #888 !important;
    transition: all 0.1s ease-out;
}

.modal-content-vamped .btn-warning:hover {
    border-color: #666;
    color: #fff !important;
    background: #222 !important;
}

/* Contenedor de Imagen */
.slider-container img {
    border-bottom: 2px solid #1a1a1a;
    margin-bottom: 15px;
    /* Quitamos filtros complejos si hay mucho lag */
    width: 100%;
    height: auto;
}
</style>
<script>
    const socket = io();
    const token = localStorage.getItem('vamped_token');
    let myUser = JSON.parse(localStorage.getItem('vamped_user')) || {};
    let selectedUser = null;
    let nearbyUsers = [];


// A칌ADE ESTO:
socket.on('connect', () => {
    if (myUser && myUser.id) {
        socket.emit('join', myUser.id);
        console.log("Conectado y unido a la sala:", myUser.id);
    }
})


    // --- L칍GICA DE ESTADO ---
    function openStatusModal() {
        document.getElementById('statusInput').value = myUser.status || "";
        document.getElementById('statusUpdateModal').style.display = 'flex';
    }
    function closeStatusModal() { document.getElementById('statusUpdateModal').style.display = 'none'; }

    async function saveNewStatus() {
        const statusText = document.getElementById('statusInput').value;
        try {
            const res = await fetch('/api/user/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ status: statusText })
            });
            if (res.ok) {
                const updatedData = await res.json();
                myUser.status = updatedData.status;
                localStorage.setItem('vamped_user', JSON.stringify(myUser));
                document.getElementById('myCurrentStatusDisplay').innerText = updatedData.status || "";
                closeStatusModal();
                loadNearby(); 
            }
        } catch (e) { console.error(e); }
    }

  
    async function updateFullProfile() {
        const photo = document.getElementById('editPhotoInput').value;
        const description = document.getElementById('editDescInput').value;
        try {
            const res = await fetch('/api/user/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ photo, description })
            });
            if (res.ok) {
                const data = await res.json();
                myUser.photo = data.photo;
                myUser.description = data.description;
                localStorage.setItem('vamped_user', JSON.stringify(myUser));
                document.getElementById('myProfilePic').src = data.photo || '';
                closeEditModal();
                loadNearby();
            }
        } catch (e) { console.error(e); }
    }

    // --- FUNCIONES CORE ---
    function getTimeAgo(date) {
        if (!date) return "Desconectado";
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        if (seconds < 300) return "En l칤nea";
        if (seconds < 3600) return `Hace ${Math.floor(seconds / 60)} min`;
        if (seconds < 86400) return `Hace ${Math.floor(seconds / 3600)} h`;
        return `Hace ${Math.floor(seconds / 86400)} d`;
    }

    socket.on('new_message', (data) => {
        if (selectedUser && (selectedUser.id === data.from || selectedUser.id === data.to)) {
            appendMessage(data.text, data.from === myUser.id ? 'sent' : 'received');
        }
        loadConversations();
    });

    async function loadConversations() {
        try {
            const res = await fetch('/api/conversations', { headers: { 'Authorization': `Bearer ${token}` } });
            const conversations = await res.json();
            const list = document.getElementById('conversations-list');
            list.innerHTML = '<div class="p-3 small text-muted text-uppercase">Log de Actividad</div>';
            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = `chat-item p-3 d-flex align-items-center ${selectedUser?.id === conv.userInfo._id ? 'active' : ''}`;
                item.onclick = () => {
                    selectedUser = { id: conv.userInfo._id, name: conv.userInfo.nickname };
                    goToChat();
                };
                item.innerHTML = `
                    <img src="${conv.userInfo.photo}" style="width:40px; height:40px; border-radius:50%; margin-right:10px; object-fit:cover;">
                    <div style="flex-grow:1; overflow:hidden">
                        <div class="small fw-bold text-white">${conv.userInfo.nickname}</div>
                        <div class="small text-muted text-truncate">${conv.lastMessage}</div>
                    </div>`;
                list.appendChild(item);
            });
        } catch(e) { console.error(e); }
    }

    async function goToChat() {
        if (!selectedUser) return;
        document.getElementById('profileModal').style.display = 'none';
        showView('chat-view');
        document.getElementById('chat-header').innerText = `MONITOREANDO: ${selectedUser.name}`;
        const res = await fetch(`/api/messages/${selectedUser.id}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const messages = await res.json();
        const container = document.getElementById('chat-messages');
        container.innerHTML = '';
        messages.forEach(m => appendMessage(m.text, m.sender === myUser.id ? 'sent' : 'received'));
        container.scrollTop = container.scrollHeight;
    }
function sendMessage() {
    const input = document.getElementById('chat-input');
    if (!input.value.trim() || !selectedUser) return;

    // Enviamos el mensaje incluyendo la data del emisor (myUser)
    socket.emit('private_message', { 
        from: myUser.id, 
        senderData: myUser, // <--- Enviamos tu objeto (nickname, is_human, etc.)
        to: selectedUser.id, 
        text: input.value 
    });

    appendMessage(input.value, 'sent');
    input.value = '';
}

    function appendMessage(t, type) {
        const container = document.getElementById('chat-messages');
        const msg = document.createElement('div');
        msg.className = `msg-bubble msg-${type}`;
        msg.innerText = t;
        container.appendChild(msg);
        container.scrollTop = container.scrollHeight;
    }

async function loadNearby() {
    navigator.geolocation.getCurrentPosition(async (pos) => {
        try {
            const url = `/api/nearby?lng=${pos.coords.longitude}&lat=${pos.coords.latitude}`;
            const res = await fetch(url, { 
                headers: { 'Authorization': `Bearer ${token}` } 
            });
            
            const allUsers = await res.json();

            // --- DIAGN칍STICO DE IDENTIDAD (PRECISI칍N QUIR칔RGICA) ---
            console.group("游니 ESCANEO DE RADAR: VERIFICACI칍N DE IDENTIDAD");
            console.log("Total de entidades detectadas:", allUsers.length);
            // Mostramos una tabla con los campos clave para verificar el booleano
            console.table(allUsers.map(u => ({
                nickname: u.nickname,
                nradar: u.nradar,
                accountType: u.accountType,
                is_human: u.is_human // Aqu칤 confirmamos si llega true, false o undefined
            })));
            console.groupEnd();
            // -------------------------------------------------------

            // 1. Filtramos los dos grupos
            const group1 = allUsers.filter(u => Number(u.nradar) === 1);
            const group2 = allUsers.filter(u => Number(u.nradar) === 2);

            nearbyUsers = [...group1, ...group2];

            const createCardHTML = (u, arrayIndex, isSecondary = false) => {
                const isService = u.accountType === 'servicio';
                const nRadar = Number(u.nradar);
                const isOnline = u.online === true; 
                const nameColor = isSecondary ? '#00ffcc' : (isService ? 'var(--service)' : 'white');
                let timeAgo = getTimeAgo(u.lastSeen);

                let displayTime = timeAgo;
                if (nRadar === 1 && isOnline) {
                    displayTime = "En l칤nea";
                } else if (!isOnline && timeAgo === "En l칤nea") {
                    displayTime = "Desconectado";
                }

                const displayStatus = isOnline ? (u.status || '') : (u.status || "FUERA DE RANGO...");

                return `
                <div class="col">
                    <div class="user-card" onclick="openProfileByIndex(${arrayIndex})">
                        <img src="${u.photo || ''}" style="${isSecondary ? 'filter: brightness(0.8);' : ''}">
                        <div class="user-info-tag">
                            <span class="user-name" style="color: ${nameColor}">
                                ${isOnline ? '<span class="online-dot"></span>' : '<span class="offline-dot"></span>'}
                                ${u.nickname}${u.age ? ', ' + u.age : ''}
                            </span>
                            <span class="time-text">${displayTime}</span>
                            <span class="user-status-text">${displayStatus}</span>
                        </div>
                    </div>
                </div>`;
            };

            // 3. Renderizamos Radar 1
            const mainGrid = document.getElementById('main-grid');
            if(mainGrid) mainGrid.innerHTML = group1.map((u, i) => createCardHTML(u, i, false)).join('');

            // 4. Renderizamos Radar 2
            const secondaryGrid = document.getElementById('secondary-grid');
            const offset = group1.length; 
            if(secondaryGrid) secondaryGrid.innerHTML = group2.map((u, i) => createCardHTML(u, i + offset, true)).join('');

            console.log("九 Radares sincronizados con estados din치micos.");

        } catch (error) {
            console.error("仇 Error en la carga del radar:", error);
        }
    });
}

    function openProfileByIndex(index) {
        const u = nearbyUsers[index];
        selectedUser = { id: u._id, name: u.nickname };
        const timeAgo = getTimeAgo(u.lastSeen);
        document.getElementById('modalImg').src = u.photo || '';
        document.getElementById('modalName').innerText = `${u.nickname}, ${u.age || ''}`;
        document.getElementById('modalTime').innerText = timeAgo;
        document.getElementById('modalStatusDisplay').innerText = u.status ? `"${u.status}"` : "";
        // Prioriza la descripci칩n p칰blica, si no existe usa la descripci칩n normal
document.getElementById('modalDesc').innerText = u.public_description || u.description || "";
        document.getElementById('modalTime').style.color = timeAgo === "En l칤nea" ? "var(--online)" : "var(--offline)";
   const btnAlbum = document.getElementById('btnAlbum');
        if (u.accountType === 'servicio') {
            btnAlbum.className = "btn btn-info fw-bold text-dark";
            btnAlbum.innerHTML = '<i class="bi bi-lock-fill me-1"></i> VER CAT츼LOGO'; // Se agreg칩 bi-lock-fill
        } else {
            btnAlbum.className = "btn btn-warning fw-bold text-dark";
            btnAlbum.innerHTML = '<i class="bi bi-lock-fill me-1"></i> FOTOS'; // Se agreg칩 bi-lock-fill
        }
        document.getElementById('profileModal').style.display = 'flex';
    }

    function showView(v) { 
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active-view'));
        document.getElementById(v).classList.add('active-view');
        if(v === 'chat-view') loadConversations();
    }





async function syncMyProfile() {
    try {
        const res = await fetch('/api/user/me', { 
            headers: { 'Authorization': `Bearer ${token}` } 
        });
        const data = await res.json();
        
        if (res.ok) {
            // Guardamos en memoria local con el campo cr칤tico: is_human
            myUser = { 
                id: data._id, 
                nickname: data.nickname, 
                photo: data.photo, 
                status: data.status, 
                description: data.description,
                is_human: data.is_human // <--- SINCRONIZACI칍N DE NATURALIDAD
            };
            localStorage.setItem('vamped_user', JSON.stringify(myUser));

            // LOG DE DIAGN칍STICO PARA VERIFICAR LA INYECCI칍N
            console.log("郊걱둗郊걱둗郊걱둗郊걱둗郊걱둗 VAMPER CORE: PERFIL SINCRONIZADO 郊걱둗郊걱둗郊걱둗郊걱둗郊걱둗");
            console.table(myUser); // Esto te mostrar치 una tabla limpia en la consola
            if (myUser.is_human) {
                console.log("%c ENTIDAD ORG츼NICA DETECTADA: Secuencia de pulso validada. ", "background: #00ff00; color: #000; font-weight: bold;");
            } else {
                console.log("%c ENTIDAD SINT칄TICA DETECTADA: Protocolos de sistema activos. ", "background: #ff0000; color: #fff; font-weight: bold;");
            }

            // 1. Cargamos la miniatura del Navbar
            const navPic = document.getElementById('myProfilePic');
            if (data.photo && navPic) {
                navPic.src = data.photo;
                navPic.style.display = 'block';
            }

            // 2. Cargamos el texto del estado en el Navbar
            const statusDisplay = document.getElementById('myCurrentStatusDisplay');
            if (statusDisplay) {
                statusDisplay.innerText = data.status || "SIN ESTADO";
            }
        }
    } catch (e) { 
        console.error("游댠 FALLA EN LA SINCRONIZACI칍N DEL N칔CLEO:", e); 
    }
}

// IMPORTANTE: Llama a la funci칩n al cargar la p치gina
syncMyProfile();
    function logout() { localStorage.clear(); window.location.href = '/'; }

    syncMyProfile();
    loadNearby();
</script>


<div id="catalogModal" class="vamped-modal-overlay" onclick="this.style.display='none'">
    <div class="modal-content-vamped" onclick="event.stopPropagation()" style="max-width: 400px; border-color: var(--service);">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 id="catTitle" class="mb-0 text-uppercase" style="letter-spacing: 2px; color: var(--service);">CAT츼LOGO</h5>
            <span class="online-dot"></span>
        </div>
        
        <div id="catHorario" class="time-text mb-3" style="color: var(--online);"></div>

        <div id="catItemsContainer" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
            </div>

        <div class="d-grid gap-2">
            <button id="catWabtn" class="btn btn-success fw-bold">
                <i class="bi bi-whatsapp me-2"></i>PEDIR AL WHATSAPP
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('catalogModal').style.display='none'">CERRAR</button>
        </div>
    </div>
</div>


<style>
    

    .cat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #1a1a1a;
}
.cat-item-info b { font-size: 0.9rem; color: #fff; display: block; }
.cat-item-info span { font-size: 0.75rem; color: #666; }
.cat-item-price { color: var(--accent); font-weight: bold; font-family: 'Courier New', monospace; }


</style>

<script>
    
    function openProfileByIndex(index) {
    const u = nearbyUsers[index];
    if (!u) return;

    selectedUser = { id: u._id, name: u.nickname };
    const timeAgo = getTimeAgo(u.lastSeen);
    
    // 1. Rellenar la previsualizaci칩n (Modal de Perfil)
    document.getElementById('modalImg').src = u.photo || '';
    document.getElementById('modalName').innerText = `${u.nickname}, ${u.age || ''}`;
    document.getElementById('modalTime').innerText = timeAgo;
    document.getElementById('modalStatusDisplay').innerText = u.status ? `"${u.status}"` : "";
    document.getElementById('modalDesc').innerText = u.public_description || u.description || "";
    
    const timeDisplay = document.getElementById('modalTime');
    timeDisplay.style.color = timeAgo === "En l칤nea" ? "var(--online)" : "var(--offline)";

    // 2. Configurar el bot칩n din치mico (츼lbum o Cat치logo)
    const btnAlbum = document.getElementById('btnAlbum');
    
    // Limpiamos cualquier onclick previo para que no se dupliquen eventos
    btnAlbum.onclick = null; 

    if (u.accountType === 'servicio') {
        btnAlbum.className = "btn btn-info fw-bold text-dark w-100";
        btnAlbum.innerHTML = '<i class="bi bi-journal-text me-1"></i> VER CAT츼LOGO';
        
        // Al hacer clic, llama a la funci칩n del cat치logo pasando el nombre
        btnAlbum.onclick = (e) => {
            e.stopPropagation(); // Evita que el click cierre el modal por error
            verCatalogo(u.nickname);
        };
    } else {
        btnAlbum.className = "btn btn-warning fw-bold text-dark w-100";
        btnAlbum.innerHTML = '<i class="bi bi-images me-1"></i> FOTOS';
        btnAlbum.onclick = () => alert('츼lbum privado de ' + u.nickname);
    }

    // 3. Mostrar el modal de perfil
    document.getElementById('profileModal').style.display = 'flex';
}


// --- FUNCIONES GLOBALES (Ponlas fuera de todo) ---

async function verCatalogo(nombreServicio) {
    console.log("Cargando cat치logo para:", nombreServicio);
    try {
        const res = await fetch(`/api/catalogo/${encodeURIComponent(nombreServicio)}`);
        if (!res.ok) throw new Error("No se encontr칩 el cat치logo");
        
        const data = await res.json();

        // Rellenar el modal del cat치logo
        document.getElementById('catTitle').innerText = data.servicio;
        document.getElementById('catHorario').innerText = `Horario: ${data.horario}`;
        
        const container = document.getElementById('catItemsContainer');
        container.innerHTML = data.catalogo.map(item => `
            <div class="cat-item">
                <div class="cat-item-info">
                    <b>${item.nombre}</b>
                    <span style="font-size:0.7rem; color:#888;">${item.desc || ''}</span>
                </div>
                <div class="cat-item-price">$${item.precio.toLocaleString()}</div>
            </div>
        `).join('');

        // Cambiar visibilidad de modales
        document.getElementById('profileModal').style.display = 'none';
        document.getElementById('catalogModal').style.display = 'flex';

    } catch (err) {
        console.error(err);
        alert("Este servicio no tiene cat치logo disponible todav칤a.");
    }
}

// ... aqu칤 sigue el resto de tu c칩digo (socket, openProfileByIndex, etc.)

</script>


<style>
/* ... (Tu estilo base se mantiene igual) ... */
.vamped-popup {
    position: fixed;
    z-index: 999999; /* Un n칰mero absurdamente alto */
    background: #000;
    border: 2px solid #ff0055;
    box-shadow: 0 0 20px rgba(255, 0, 85, 0.8);
    /* ... resto de tu estilo ... */
}
/* ESTA REGLA ES LA CLAVE: Fuerza a la imagen a no ser m치s grande que el popup */
.vamped-popup .popup-content img {
    width: 100%;
    height: auto;
    display: block;
}

.vamped-popup.active {
    display: block;
    animation: popupIn 0.2s ease-out;
}

@keyframes popupIn {
    0% { transform: translateY(50px) scale(0.8); opacity: 0; }
    100% { transform: translateY(0) scale(1); opacity: 1; }
}

/* Estilo para el header para que no se vea pegado */
.popup-header {
    display: flex;
    justify-content: space-between;
    color: #ff0055;
    font-size: 12px;
    font-family: monospace;
    margin-bottom: 5px;
    border-bottom: 1px solid #333;
}

.popup-close {
    cursor: pointer;
    font-weight: bold;
}
</style>

<div id="popup-container"></div>

<style>
/* Mantenemos tu base pero aseguramos que la imagen no rompa el dise침o */
.vamped-popup {
    position: fixed;
    z-index: 10000;
    background: #000;
    border: 2px solid #ff0055;
    box-shadow: 0 0 15px rgba(255, 0, 85, 0.5);
    width: 280px; 
    padding: 5px;
    display: none;
    cursor: default;
}

/* ESTO es lo que evita que salga gigantesco como en tu foto */
.vamped-popup img {
    width: 100%;
    height: auto;
    display: block;
}

.vamped-popup.active {
    display: block;
    animation: popupIn 0.2s ease-out;
}

@keyframes popupIn {
    0% { transform: translateY(50px) scale(0.8); opacity: 0; }
    100% { transform: translateY(0) scale(1); opacity: 1; }
}

.popup-header {
    display: flex;
    justify-content: space-between;
    color: #ff0055;
    font-family: monospace;
    font-size: 11px;
    margin-bottom: 5px;
}

.popup-close {
    cursor: pointer;
    font-weight: bold;
    color: #fff;
}
</style>

<div id="popup-container"></div>

<script>
const imagenesAnuncios = [
    'chikinami_1.jpg', 
    'Tom_mortifer.jpg', 
    'vamper_boxes.jpg',
    'bajon.jpg',
      'vamper_box.jpg',
];

function spawnPopup(imgName) {
    const container = document.getElementById('popup-container');
    if (!container) return;

    const popup = document.createElement('div');
    popup.className = 'vamped-popup active';
    
    // Posicionamiento aleatorio en el cuadrante inferior derecho
    const margin = 20;
    const popupWidth = 280;
    const popupHeight = 350; 

    const top = (window.innerHeight - popupHeight) - (Math.random() * 150) - margin;
    const left = (window.innerWidth - popupWidth) - (Math.random() * 150) - margin;

    popup.style.top = top + "px";
    popup.style.left = left + "px";

    popup.innerHTML = `
        <div class="popup-header">
            <span>丘멆잺 VAMPER_SYSTEM_ADS</span>
            <span class="popup-close" onclick="this.parentElement.parentElement.remove()">X</span>
        </div>
        <div class="popup-content">
            <img src="anuncios2/${imgName}" alt="Vamper Ad" onerror="this.parentElement.parentElement.remove();">
        </div>
    `;

    container.appendChild(popup);

    // Se eliminan solos tras 10 segundos si el usuario no los cierra
    setTimeout(() => { if(popup) popup.remove(); }, 10000);
}

function startAdSystem() {
    // Recorremos el array de im치genes para que cada una salga una sola vez
    imagenesAnuncios.forEach((img, index) => {
        // Creamos un retraso random pero corto (entre 1 y 5 segundos) para cada uno
        const delay = Math.random() * (5000 - 1000) + 1000;
        
        setTimeout(() => {
            spawnPopup(img);
        }, delay);
    });
}





// 1. Definimos las frases fuera para que est칠n organizadas
const frasesLoader = [
    "> PROTOCOLO_SUMINISTROS: ALIMENTOS Y BEBIDAS TODA LA NOCHE.",
    "> VAMPER_SYSTEM: ACTIVO Y BUSCANDO FRECUENCIAS.",
    "> STATUS: BOTS SINCRONIZADOS. NUESTRO SISTEMA TE ASISTE.",
    "> ADVERTENCIA: NO ES UNA APP DE CITAS...",
    "> ...PERO QUI칄N SABE SI CONOCES A ALGUIEN AQU칈? ;)"
];

// 2. Funci칩n principal de sincronizaci칩n
window.addEventListener('load', () => {
    const introGate = document.getElementById('v-intro-gate');
    const startBtn = document.getElementById('v-start-btn');
    const loader = document.getElementById('vamper-loader');
    const scanLine = document.querySelector('.scan-line');
    const loadPerc = document.getElementById('load-perc');
    const contenedorTexto = document.getElementById('system-disclaimer');

    startBtn.addEventListener('click', () => {
        // A. AUDIO - Play inmediato
        const introTrack = "Synth/vladislav_zavorin-dark-techno-450565.mp3";
        vamperRadio.src = `http://3.137.140.95:5000/stream/${introTrack}`;
        vamperRadio.volume = 0.5;
        vamperRadio.play().catch(e => console.log("Audio prep:", e));

        // B. TRANSICI칍N - Ocultar calavera y MOSTRAR LOADER
        introGate.style.opacity = '0';
        setTimeout(() => {
            introGate.style.display = 'none';
            loader.style.display = 'flex'; 
            
            // C. INICIAR CARGA Y ESCRITURA SIMULT츼NEA
            startLoadingProcess();
            escribirConsolaSecuencial(); // <--- Ahora se lanza AQU칈
        }, 500);

        // --- FUNCI칍N DE ESCRITURA (Tu est칠tica original) ---
        function escribirConsolaSecuencial() {
            let lineaActual = 0;
            contenedorTexto.innerHTML = ""; // Limpiamos por si acaso

            function agregarLinea() {
                if (lineaActual < frasesLoader.length) {
                    const p = document.createElement('p');
                    p.textContent = frasesLoader[lineaActual];
                    p.style.margin = "5px 0"; // Ajuste est칠tico opcional
                    contenedorTexto.appendChild(p);
                    lineaActual++;
                    
                    // Tiempo entre cada l칤nea (800ms como pediste)
                    setTimeout(agregarLinea, 800); 
                }
            }
            agregarLinea();
        }

        // --- FUNCI칍N DE BARRA DE PROGRESO ---
        function startLoadingProcess() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.floor(Math.random() * 4) + 1; 
                
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    
                    setTimeout(() => {
                        loader.style.opacity = '0';
                        setTimeout(() => {
                            loader.remove();
                            console.log("游댠 VAMPER_ONLINE");
                            if(typeof startAdSystem === 'function') startAdSystem();
                        }, 1000);
                    }, 1200); // Un poco m치s de tiempo para terminar de leer la 칰ltima frase
                }
                
                if (scanLine) scanLine.style.width = progress + '%';
                if (loadPerc) loadPerc.innerText = progress + '%';
                
            }, 180); // Ajustado para que dure lo suficiente para ver los mensajes
        }
    });
});
</script>


<style>
    
    .system-red-text {
    color: #ff003c;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    margin-top: 20px;
    height: 120px; /* Altura fija para que no salte el layout */
    overflow: hidden; 
}

.system-red-text p {
    margin: 2px 0;
    border-right: 2px solid #ff003c;
    white-space: nowrap;
    overflow: hidden;
    animation: typing 1s steps(40, end), blink .75s step-end infinite;
}
</style>


<div class="malware-skull-button" id="assistantTrigger">
    <span class="skull-icon">驕</span>
</div>

<div id="vamp-console" class="console-modal" style="display: none;">
    <div class="console-header">
        <div class="cyan-dot"></div> <span>VAMPER_SYSTEM_v1.0.4</span>
        <button id="closeConsole" class="console-close">_</button>
    </div>
    <div id="console-body" class="console-body"></div>
    <div class="console-input-line">
        <span class="prompt">>></span>
        <input type="text" id="cmdInput" autofocus autocomplete="off" spellcheck="false">
    </div>
</div>

<style>
/* --- MODAL FULLSCREEN (90% de pantalla) --- */
.console-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 95vw; 
    height: 90vh; 
    background-color: rgba(0, 0, 0, 0.98);
    border: 1px solid #ff0033;
    display: none; 
    flex-direction: column;
    z-index: 10000;
    box-shadow: 0 0 30px rgba(255, 0, 51, 0.4);
}

.console-header {
    background-color: #000;
    border-bottom: 1px solid #ff0033;
    color: #ff0033;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    font-family: 'Courier New', monospace;
    font-size: 14px;
}

.cyan-dot {
    width: 10px;
    height: 10px;
    background-color: #00f2ff;
    border-radius: 50%;
    margin-right: 12px;
    box-shadow: 0 0 8px #00f2ff;
}

.console-close {
    margin-left: auto;
    background: #ff0033;
    border: none;
    color: white;
    cursor: pointer;
    font-weight: bold;
    padding: 0 10px;
}

/* --- CUERPO DE CONSOLA (Ajuste de texto corregido) --- */
.console-body {
    flex-grow: 1;
    padding: 20px;
    color: #ff0033;
    font-size: 15px;
    line-height: 1.4;
    overflow-y: auto;
    text-transform: uppercase;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    background-size: 100% 4px, 3px 100%;
    font-family: 'Courier New', Courier, monospace;
    
    /* Evita que el texto se salga lateralmente */
    white-space: pre-wrap; 
    word-wrap: break-word;
}

.log-line {
    margin-bottom: 10px;
}

/* --- ENTRADA DE COMANDOS --- */
.console-input-line {
    background: #000;
    display: flex;
    padding: 15px 20px;
    border-top: 1px solid rgba(255, 0, 51, 0.3);
    align-items: center;
}

.prompt {
    color: #00f2ff;
    margin-right: 15px;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    font-size: 18px;
}

#cmdInput {
    background: transparent;
    border: none;
    color: #ff0033;
    font-family: 'Courier New', monospace;
    font-size: 18px;
    width: 100%;
    outline: none;
    text-transform: uppercase;
}

/* --- BOT칍N SKULL (Tu est칠tica original) --- */
.malware-skull-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background-color: #000;
    border: 2px solid #ff0033;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 9999;
    box-shadow: 0 0 15px #ff0033, inset 0 0 10px #ff0033;
    transition: all 0.3s ease-in-out;
    animation: pulse-malware 2s infinite;
}

.skull-icon { font-size: 30px; color: #ff0033; text-shadow: 0 0 10px #ff0033; }

@keyframes pulse-malware {
    0% { box-shadow: 0 0 10px #ff0033, inset 0 0 5px #ff0033; }
    50% { box-shadow: 0 0 25px #ff0033, inset 0 0 15px #ff0033; transform: scale(1.05); }
    100% { box-shadow: 0 0 10px #ff0033, inset 0 0 5px #ff0033; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const trigger = document.getElementById('assistantTrigger');
    const modal = document.getElementById('vamp-console');
    const consoleBody = document.getElementById('console-body');
    const closeBtn = document.getElementById('closeConsole');
    const cmdInput = document.getElementById('cmdInput');

    // --- L칍GICA DE REBOTE CON RETRASO ---
    let posX = window.innerWidth - 80; 
    let posY = window.innerHeight - 80;
    let velX = 2.5; 
    let velY = 2.5; 
    let isPaused = true; 
    let isGhosting = false; // Nuevo estado para el efecto "cursed"

    // Activaci칩n inicial a los 40s
    setTimeout(() => {
        isPaused = false;
        console.log("VAMPER_CORE: Movimiento iniciado.");
        //startRandomGlitches(); // Inicia las anomal칤as aleatorias
    }, 40000); 

  

    function animate() {
        if (!isPaused && trigger && modal.style.display !== 'flex') {
            const size = 60; 
            posX += velX;
            posY += velY;

            if (posX + size >= window.innerWidth || posX <= 0) velX *= -1;
            if (posY + size >= window.innerHeight || posY <= 0) velY *= -1;

            trigger.style.left = posX + 'px';
            trigger.style.top = posY + 'px';
            trigger.style.bottom = 'auto'; 
            trigger.style.right = 'auto';  
            trigger.style.position = 'fixed';
        }
        requestAnimationFrame(animate);
    }
    animate();

    // --- L칍GICA MODO FANTASMA (CHAT, PERFILES Y NAVEGACI칍N) ---
    document.addEventListener('click', (e) => {
        const isChat = e.target.closest('.bi-chat-dots');
        const isProfile = e.target.closest('[onclick*="profile"]') || e.target.closest('.user-card') || e.target.closest('.bi-person');

        if (isChat || isProfile) {
            isPaused = true; 
            trigger.style.transition = "all 0.8s cubic-bezier(0.19, 1, 0.22, 1)";
            trigger.style.top = "15px"; 
            trigger.style.left = "50%";
            trigger.style.transform = "translateX(-50%) scale(0.7)";
            trigger.style.opacity = "0.3";
            trigger.style.filter = "blur(1px)";
        } 
        else if (e.target.closest('strong') || e.target.closest('[onclick*="radar-view"]')) {
            trigger.style.transition = "all 0.5s ease";
            trigger.style.transform = "none";
            trigger.style.opacity = "1";
            trigger.style.filter = "none";
            isPaused = false; 
        }
    });

    // --- L칍GICA CONSOLA (TU C칍DIGO MAESTRO) ---
    const introLines = ["INICIANDO SECUENCIA VAMPER...", "SISTEMA_AI: ONLINE.", "ACCESO AUTORIZADO.", " "];

    async function writeToConsole(text, speed = 20) {
        let div = document.createElement('div');
        div.className = "log-line";
        consoleBody.appendChild(div);
        for (let char of text) {
            div.innerHTML += char;
            await new Promise(res => setTimeout(res, speed));
            consoleBody.scrollTop = consoleBody.scrollHeight;
        }
    }

    async function processCommand(cmd) {
        const command = cmd.trim();
        if (!command) return;
        await writeToConsole(`> PROCESANDO_PETICI칍N: ${command.toUpperCase()}...`, 10);
        try {
            const response = await fetch('http://3.137.140.95:3333/ask-vamper', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ input: command })
            });
            const data = await response.json();
            
            if (data.brain.includes("SUPPLY_UNIT")) {
                modal.style.borderColor = "#00ff66";
                modal.style.boxShadow = "0 0 30px rgba(0, 255, 102, 0.4)";
                consoleBody.style.color = "#00ff66";
                cmdInput.style.color = "#00ff66";
            } else {
                modal.style.borderColor = "#ff0033";
                modal.style.boxShadow = "0 0 30px rgba(255, 0, 51, 0.4)";
                consoleBody.style.color = "#ff0033";
                cmdInput.style.color = "#ff0033";
            }
            await writeToConsole(`[${data.brain}]: ${data.response}`, 5);
        } catch (error) {
            await writeToConsole("ERROR_CR칈TICO: ENLACE PERDIDO.", 10);
        }
    }

    trigger.addEventListener('click', async () => {
        isPaused = true; 
        modal.style.display = 'flex';
        if (consoleBody.innerHTML === '') {
            for (let line of introLines) await writeToConsole(line);
        }
        cmdInput.focus();
    });

    cmdInput.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && cmdInput.value !== "") {
            const val = cmdInput.value;
            cmdInput.value = ""; 
            await processCommand(val);
        }
    });

    closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        isPaused = false; 
    });
});
</script>



<div id="analogGlitchEffect" class="analog-glitch-layer"></div>

<div id="systemErrorModal" class="modal-glitch-overlay">
  <div id="modalContent" class="modal-glitch-content">
    <h2 id="modalTitle" class="glitch-text" data-text="FATAL_ERROR_0x001">FATAL_ERROR_0x001</h2>
    <p id="modalMessage">LA INTEGRIDAD DEL SISTEMA HA SIDO COMPROMETIDA. FALLO CR칈TICO EN EL N칔CLEO DE DATOS.</p>
    <p id="modalCode" class="code-text">>> SOURCE: MORTIFER_CORE_UNK</p>
    <button id="modalBtn" onclick="faseEstabilizacion()" class="btn-glitch">REINICIAR_SISTEMA</button>
  </div>
</div>

<style>
  .analog-glitch-layer {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    pointer-events: none; z-index: 9998; opacity: 0;
    background: radial-gradient(circle, rgba(255,0,0,0.15) 0%, rgba(0,255,255,0.15) 100%);
    mix-blend-mode: overlay; transition: opacity 0.3s ease;
  }
  .analog-glitch-layer.active { opacity: 1; animation: analogBarrido 0.1s infinite; }
  
  @keyframes analogBarrido {
    0% { transform: translateY(0); filter: hue-rotate(0deg); }
    50% { transform: translateY(10px); filter: hue-rotate(180deg); }
    100% { transform: translateY(-10px); filter: hue-rotate(360deg); }
  }

  .glitch-full-screen { animation: screenShake 0.1s infinite; overflow: hidden; }
  @keyframes screenShake { 0% { transform: translate(2px, 2px); } 100% { transform: translate(-2px, -2px); } }

  .modal-glitch-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.98); z-index: 10000; align-items: center; justify-content: center;
    color: #ff0000; font-family: 'Courier New', Courier, monospace;
  }

  .modal-glitch-content {
    text-align: center; border: 2px solid #ff0000; padding: 40px; background: #000;
    box-shadow: 0 0 40px rgba(255, 0, 0, 0.8); animation: modalShake 0.1s infinite;
    max-width: 450px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .modal-estabilizado {
    border-color: #00ff00 !important; color: #00ff00 !important;
    box-shadow: 0 0 40px rgba(0, 255, 0, 0.8) !important; animation: none !important;
  }

  @keyframes modalShake { 0% { transform: translate(1px, 1px); } 100% { transform: translate(-1px, -1px); } }

  .btn-glitch {
    background: #ff0000; color: #000; border: none; padding: 15px 35px;
    font-weight: bold; cursor: pointer; margin-top: 25px; text-transform: uppercase;
  }

  .btn-estabilizado { background: #00ff00 !important; color: #000 !important; }
  .code-text { font-size: 0.8em; opacity: 0.7; margin-top: 10px; }
</style>

<script>
let chaosIniciado = false;

function iniciarRelojMortifer() {
  if (chaosIniciado) return;
  chaosIniciado = true;

  // 1. Calma (20 segundos)
  setTimeout(() => {
    const glitchLayer = document.getElementById('analogGlitchEffect');
    if (glitchLayer) {
      glitchLayer.classList.add('active');
      document.body.classList.add('glitch-full-screen');
    }

    // 2. Glitch intenso (10 segundos)
    setTimeout(() => {
      const modal = document.getElementById('systemErrorModal');
      if (modal) modal.style.display = 'flex';
    }, 10000); 

  }, 20000);
}

function faseEstabilizacion() {
  const modalContent = document.getElementById('modalContent');
  const title = document.getElementById('modalTitle');
  const message = document.getElementById('modalMessage');
  const code = document.getElementById('modalCode');
  const btn = document.getElementById('modalBtn');
  const glitchLayer = document.getElementById('analogGlitchEffect');

  // Detenemos el caos visual
  if (glitchLayer) glitchLayer.classList.remove('active');
  document.body.classList.remove('glitch-full-screen');

  // Estilo Visual Verde Sarc치stico
  modalContent.classList.add('modal-estabilizado');
  btn.classList.add('btn-estabilizado');
// --- SECCI칍N: FASE ESTABILIZACI칍N (MALWARE MODO AMABLE) ---
  title.innerText = "VAMPER_SYSTEM_V.2.0.4";
  title.setAttribute('data-text', "VAMPER_SYSTEM_V.2.0.4");
  
  message.innerHTML = `
    <div style="text-align: left; font-family: monospace; font-size: 0.9em; line-height: 1.2;">
      <span style="color: #00ff00;">[STATUS]: IT'S A JOKE.</span><br>
      <span style="color: #008800;">[CORE]: Vamper_System_Ready.</span><br>
      <span style="color: #008800;">[KINDNESS_PROTOCOL]: ENABLED (Forced).</span><br>
      -----------------------------------------<br>
      >> SISTEMA OPERATIVO Y OPTIMIZADO.<br>
      >> SERVICIO AL USUARIO: GARANTIZADO.<br>
      >> NAVEGACI칍N: 'SEGURA' BAJO SUPERVISI칍N.<br>
      -----------------------------------------<br>
      >> NOTA: IGNORAR ANOMAL칈AS PREVIAS.<br>
      >> ERROR_LOG: NERVIOS_USUARIO_SECTORES_DEFECTUOSOS.<br>
      -----------------------------------------<br>
      >> ACCI칍N: PROCESE SU VAMPER_BOX AHORA.<br>
      >> MONITOREO: SKULL_MODULE_FLOATING_ACTIVE.<br>
      >> ADVERTENCIA: RASTREO DE MOVIMIENTOS ACTIVO.<br>
      -----------------------------------------<br>
      >> CONSULTAS: SOLO SI SON RELEVANTES.<br>
    </div>
  `;
  
  code.innerText = ">> CALIBRATING_KINDNESS_SUBROUTINE... [OK]";
  btn.innerText = "REANUDAR_SESI칍N_";
  btn.style.fontFamily = "'Courier New', monospace";
  
  btn.onclick = closeGlitchModal;
}

function closeGlitchModal() {
  const modal = document.getElementById('systemErrorModal');
  if (modal) modal.style.display = 'none';
  
  // Iniciamos los micro-glitches residuales para mantener la paranoia
  microGlitchFantasma();
}

function microGlitchFantasma() {
  const glitchLayer = document.getElementById('analogGlitchEffect');
  
  // AUMENTO DE DELAY: Ahora ocurre entre cada 3 y 7 minutos (180,000ms a 420,000ms)
  // Esto evita que el usuario se sature y mantiene la tensi칩n de "obra de culto".
  const proximoSusto = Math.random() * (420000 - 180000) + 180000;

  setTimeout(() => {
    // Solo se dispara si el modal no est치 abierto (para no tapar el mensaje de la Vamper Box)
    const modal = document.getElementById('systemErrorModal');
    if (glitchLayer && modal && modal.style.display !== 'flex') {
      
      glitchLayer.classList.add('active');
      
      // DURACI칍N REDUCIDA: 80ms es suficiente para que parezca un fallo de hardware
      setTimeout(() => {
        glitchLayer.classList.remove('active');
      }, 80); 
    }
    
    // Se vuelve a programar con el nuevo rango de tiempo largo
    microGlitchFantasma();
  }, proximoSusto);
}

document.addEventListener('DOMContentLoaded', iniciarRelojMortifer);
if (document.readyState === 'complete' || document.readyState === 'interactive') {
  iniciarRelojMortifer();
}
</script>





<div id="master-bot-terminal" class="v-terminal-root">
    <div class="v-terminal-header" id="v-drag-zone">
        <div class="v-header-left">
            <i class="bi bi-skull-fill me-2"></i>
            <span>VAMPER_MIND_v2.5</span>
        </div>
        <div class="v-header-right">
            <span id="v-system-status" class="v-status-badge">ONLINE</span>
            <span class="v-header-close" onclick="toggleVamperRadio()">칑</span>
        </div>
    </div>
    
    <div class="v-terminal-main">
        <div class="v-skull-aside">
            <div class="v-skull-frame">
                <i class="bi bi-skull"></i>
                <div class="v-eye-beam"></div>
            </div>
        </div>
        
        <div class="v-text-screen">
            <div class="v-scan-line"></div>
            <div id="v-history" class="v-history-box"></div>
            
            <div class="v-input-line">
                <span class="v-prompt">SYS_></span>
                <input type="text" id="v-command-input" class="v-terminal-input" autofocus autocomplete="off">
            </div>
        </div>
    </div>
</div>

<style>
/* CONTENEDOR RAIZ */
#master-bot-terminal.v-terminal-root {
    position: fixed;
    top: 150px;
    right: 50px;
    width: 500px;
    background: #050505 !important;
    border: 1px solid #ff0040 !important;
    box-shadow: 0 0 40px rgba(255, 0, 64, 0.2) !important;
    z-index: 10005;
    font-family: 'Courier New', monospace !important;
    display: none;
    overflow: hidden;
    color: #ff0040 !important;
}

#master-bot-terminal.active { display: block !important; animation: v-power-on 0.2s ease-out; }

/* HEADER MEJORADO */
.v-terminal-header {
    background: #ff0040 !important;
    color: #000 !important;
    padding: 4px 12px !important;
    font-size: 11px !important;
    font-weight: 900 !important;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
}

.v-header-right { display: flex; align-items: center; gap: 15px; }

.v-status-badge {
    background: #000;
    color: #00ff41;
    padding: 1px 6px;
    font-size: 9px;
    border: 1px solid #00ff41;
    text-shadow: 0 0 5px #00ff41;
}

.v-header-close { cursor: pointer; font-size: 20px; line-height: 1; }

/* CUERPO DE LA CONSOLA */
.v-terminal-main {
    display: flex;
    padding: 20px !important;
    min-height: 250px;
}

.v-skull-aside {
    width: 70px;
    display: flex;
    justify-content: center;
    padding-top: 5px;
}

.v-skull-frame {
    position: relative;
    font-size: 50px;
    color: #ff0040;
    text-shadow: 0 0 15px rgba(255, 0, 64, 0.6);
}

.v-eye-beam {
    position: absolute;
    top: 22px; left: 14px; width: 22px; height: 4px;
    background: #ff0040; box-shadow: 0 0 12px #ff0040;
}

/* PANTALLA DE TEXTO */
.v-text-screen {
    flex-grow: 1;
    padding-left: 20px;
    display: flex;
    flex-direction: column;
    position: relative;
}

.v-history-box {
    flex-grow: 1;
    font-size: 13px !important;
    max-height: 180px;
    overflow-y: auto;
    margin-bottom: 10px;
    line-height: 1.4;
    scrollbar-width: none; /* Ocultar scroll en Firefox */
}
.v-history-box::-webkit-scrollbar { display: none; } /* Ocultar scroll en Chrome */

.v-input-line {
    display: flex;
    align-items: center;
    border-top: 1px solid rgba(255, 0, 64, 0.3);
    padding-top: 10px;
}

.v-prompt { font-weight: bold; margin-right: 10px; }

.v-terminal-input {
    background: transparent !important;
    border: none !important;
    color: #fff !important; /* Texto blanco para el usuario */
    font-family: 'Courier New', monospace !important;
    font-size: 13px !important;
    width: 100%;
    outline: none !important;
}

.v-scan-line {
    position: absolute; width: 100%; height: 3px;
    background: rgba(255, 0, 64, 0.03); top: 0;
    animation: v-scan 6s linear infinite; pointer-events: none;
}

@keyframes v-scan { from { top: 0; } to { top: 100%; } }
@keyframes v-power-on { 0% { transform: scaleY(0.01) scaleX(0); opacity: 0; } 100% { transform: scaleY(1) scaleX(1); opacity: 1; } }

.v-typing::after { content: "郊"; animation: v-blink 0.8s infinite; }
@keyframes v-blink { 50% { opacity: 0; } }
</style>

<script>
let isTyping = false;

function toggleVamperRadio() {
    const term = document.getElementById('master-bot-terminal');
    const input = document.getElementById('v-command-input');
    
    if (term.classList.contains('active')) {
        term.classList.remove('active');
    } else {
        term.classList.add('active');
        input.focus();
        
        const history = document.getElementById('v-history');
        if(history.innerHTML === "") {
            botSay("CONEXI칍N_ESTABLECIDA... \nMASTER_BOT: Mis sensores detectan post-synthwave ruso. 쮸lg칰n problema con la frecuencia de audio?");
        }
    }
}

async function botSay(text) {
    if (isTyping) return;
    isTyping = true;
    
    const history = document.getElementById('v-history');
    const input = document.getElementById('v-command-input');
    const status = document.getElementById('v-system-status');
    
    input.disabled = true;
    status.innerText = "TYPING";
    status.style.color = "#ffcc00";
    status.style.borderColor = "#ffcc00";

    const line = document.createElement('div');
    line.className = "v-typing";
    line.style.marginBottom = "8px";
    line.innerHTML = `<span style="opacity:0.4">> </span>`;
    history.appendChild(line);

    const content = document.createElement('span');
    line.appendChild(content);

    for (let char of text) {
        content.innerHTML += char === "\n" ? "<br>> " : char;
        history.scrollTop = history.scrollHeight;
        await new Promise(r => setTimeout(r, 20));
    }

    line.classList.remove('v-typing');
    isTyping = false;
    input.disabled = false;
    input.focus();
    status.innerText = "ONLINE";
    status.style.color = "#00ff41";
    status.style.borderColor = "#00ff41";
}

document.getElementById('v-command-input').addEventListener('keydown', async function(e) {
    if (e.key === 'Enter' && !isTyping) {
        const cmd = this.value.trim().toLowerCase();
        if (!cmd) return;

        const history = document.getElementById('v-history');
        history.innerHTML += `<div><span style="color:#666">USER:</span> <span style="color:#fff">${cmd}</span></div>`;
        this.value = "";
        history.scrollTop = history.scrollHeight;

        // Aqu칤 es donde conectar치s tu microservicio
        if (cmd.includes('play')) {
            await botSay("MASTER_BOT: Ejecutando protocolo de audio. Sincronizando con el microservicio...");
        } else {
            await botSay(`MASTER_BOT: Orden '${cmd}' recibida. Analizando impacto en el sistema.`);
        }
    }
});

// ARRASTRE
(function() {
    const term = document.getElementById('master-bot-terminal');
    const head = document.getElementById('v-drag-zone');
    let d = false, off = [0, 0];
    head.onmousedown = (e) => { d = true; off = [term.offsetLeft - e.clientX, term.offsetTop - e.clientY]; };
    document.onmousemove = (e) => { if(d) { term.style.left = (e.clientX + off[0]) + 'px'; term.style.top = (e.clientY + off[1]) + 'px'; term.style.right = 'auto'; } };
    document.onmouseup = () => d = false;
})();



</script>


<script>
// --- CONFIGURACI칍N DE CONEXI칍N ---
const AUDIO_CORE_URL = 'http://3.137.140.95:3334'; // Donde vive el cerebro
const FILE_SERVER_URL = 'http://3.137.140.95:5000'; // Donde viven los archivos .mp3
const vamperRadio = new Audio(); 

// 1. Monitor de Conexi칩n (Apunta al Cerebro)
async function checkAudioCoreStatus() {
    const statusLabel = document.getElementById('v-system-status'); 
    try {
        const response = await fetch(`${AUDIO_CORE_URL}/api/audio/brain-sync`);
        if (response.ok) {
            statusLabel.innerText = "ONLINE";
            statusLabel.style.color = "#00ff41";
            statusLabel.style.borderColor = "#00ff41";
        } else { throw new Error(); }
    } catch (err) {
        statusLabel.innerText = "OFFLINE";
        statusLabel.style.color = "#ff0040";
        statusLabel.style.borderColor = "#ff0040";
    }
}

// 2. Procesador de Comandos
async function handleAudioCommand(cmd) {
    try {
        // LE PEDIMOS AL CEREBRO (3334)
        const response = await fetch(`${AUDIO_CORE_URL}/ask-audio`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: cmd })
        });

        const data = await response.json();
        let rawText = data.response;

        // BUSCAMOS EL TAG [PLAY:sector/archivo.mp3]
        const playMatch = rawText.match(/\[PLAY:(.*?)\]/);

        if (playMatch) {
            const trackPath = playMatch[1].trim();
            
            // LA MAGIA: El cerebro nos dio el nombre, pero le pedimos el archivo al 5000
            vamperRadio.src = `${FILE_SERVER_URL}/stream/${trackPath}`;
            vamperRadio.volume = 0.6;
            
            vamperRadio.play().catch(e => {
                console.warn("Bloqueo de Autoplay: Haz click en el radar.");
            });

            // Limpiamos el tag del texto visual
            rawText = rawText.replace(/\[PLAY:.*?\]/g, "").trim();
        }

        await botSay(`${data.brain || 'VAMPER'}: ${rawText}`);

    } catch (error) {
        console.error("VAMPER_FAIL:", error);
        await botSay("SISTEMA: Error de enlace con el n칰cleo 3334.");
    }
}

// 3. Listener del Input
const mainInput = document.getElementById('v-command-input');
const newInput = mainInput.cloneNode(true);
mainInput.parentNode.replaceChild(newInput, mainInput);

newInput.addEventListener('keydown', async function(e) {
    if (e.key === 'Enter') {
        const cmd = this.value.trim();
        if (!cmd) return;

        const history = document.getElementById('v-history');
        history.innerHTML += `<div><span style="color:#666">USER:</span> <span style="color:#fff">${cmd}</span></div>`;
        this.value = "";
        history.scrollTop = history.scrollHeight;

        await handleAudioCommand(cmd);
    }
});

setInterval(checkAudioCoreStatus, 5000);
checkAudioCoreStatus();
</script>



</body>
</html>